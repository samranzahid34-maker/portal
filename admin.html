<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Subject Marks</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base Layout */
        .admin-layout {
            display: grid;
            min-height: calc(100vh - 70px);
            flex: 1;
            position: relative;
        }

        /* Navbar specifics for Admin to match layout calculations */
        .navbar {
            height: 70px;
            position: sticky;
            top: 0;
            z-index: 50;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Sidebar Styling */
        .sidebar {
            background: #111827;
            color: white;
            height: 100%;
            overflow: hidden;
            width: 100%;
        }

        .sidebar-inner {
            width: 250px;
            padding: 2rem;
        }

        .hamburger-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
        }

        .sidebar-link {
            display: block;
            padding: 1rem;
            color: #9ca3af;
            text-decoration: none;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .sidebar-link:hover {
            color: white;
            background: #374151;
        }

        .sidebar-link.active {
            background: #6366f1;
            color: white;
            font-weight: 600;
        }

        .main-content {
            padding: 2rem;
            background: #f8fafc;
        }

        .source-list {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            margin-top: 1rem;
        }

        .source-item {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
        }

        .mobile-only {
            display: none;
        }

        /* Desktop Layout (min-width: 769px) */
        @media (min-width: 769px) {
            .admin-layout {
                grid-template-columns: 0px 1fr;
                transition: grid-template-columns 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .admin-layout.sidebar-visible {
                grid-template-columns: 250px 1fr;
            }

            .sidebar {
                border-right: 1px solid #374151;
            }
        }

        /* Mobile Layout (max-width: 768px) */
        @media (max-width: 768px) {
            .mobile-only {
                display: flex !important;
            }

            .admin-layout {
                display: block;
                /* Stack layout */
            }

            .navbar {
                z-index: 50;
                /* Ensure navbar stays below high overlays if needed, but sidebar will cover it */
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                /* Slightly wider for better touch targets */
                height: 100vh;
                z-index: 200;
                /* Above navbar */
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border-right: none;
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            }

            /* Show sidebar when toggled */
            .admin-layout.sidebar-visible .sidebar {
                transform: translateX(0);
                display: block;
            }

            /* Overlay effect */
            .admin-layout.sidebar-visible::after {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                /* Darker overlay */
                z-index: 150;
                /* Between sidebar and content/navbar */
                backdrop-filter: blur(2px);
                animation: fadeIn 0.3s;
            }

            .main-content {
                padding: 1rem;
            }

            .source-item {
                flex-direction: column;
                gap: 1rem;
            }

            .card-grid-container {
                grid-template-columns: 1fr !important;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div style="display:flex; align-items:center">
            <button class="hamburger-btn" onclick="toggleSidebar()" aria-label="Menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="nav-links">
            <button id="logout-btn" onclick="logout()"
                style="display:none; background:none; border:none; color:inherit; cursor:pointer;">Logout</button>
        </div>
    </nav>

    <div class="admin-layout" id="admin-panel" style="display:none">
        <aside class="sidebar">
            <div class="sidebar-inner">
                <div style="display:flex; justify-content:flex-end; margin-bottom:1rem;" class="mobile-only">
                    <button onclick="toggleSidebar()"
                        style="background:none; border:none; color:white; cursor:pointer;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <a href="#" class="sidebar-link active" onclick="switchTab('dashboard', this)">Dashboard</a>
                <a href="#" class="sidebar-link" onclick="switchTab('sources', this)">Sheets Source</a>
                <a href="#" class="sidebar-link" onclick="switchTab('results', this)">Check Results</a>
                <a href="#" class="sidebar-link" onclick="switchTab('statistics', this)">Stat & Grades</a>
                <button onclick="refreshData()" class="btn-primary"
                    style="margin:1rem; width:calc(100% - 2rem); font-size:0.9rem; background: #000000; border: 1px solid #333;">
                    Refresh Data</button>
            </div>
            <!-- <a href="#" class="sidebar-link">Settings</a> -->
        </aside>

        <main class="main-content">
            <!-- TAB 0: DASHBOARD -->
            <div id="tab-dashboard">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <div>
                        <h2 id="dashboard-welcome" style="margin-bottom: 0.5rem; font-weight:700;">Welcome, Admin</h2>
                        <p id="dashboard-email" style="color: #64748b; font-size: 0.95rem;">Loading profile...</p>
                    </div>
                    <button onclick="loadDashboard()" class="btn-secondary"
                        style="font-size:0.9rem; background:#000; color:#fff; border:1px solid #333;">Refresh</button>
                </div>

                <!-- Summary Cards -->
                <div class="card-grid-container"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;">
                    <div class="card"
                        style="background:#6366f1; color:white; padding:2rem; border-radius:1rem; box-shadow:0 10px 25px -5px rgba(99, 102, 241, 0.3);">
                        <div
                            style="font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; opacity:0.9; margin-bottom:0.5rem;">
                            Total Students</div>
                        <div id="dash-total-students" style="font-size:3rem; font-weight:700;">-</div>
                        <div style="font-size:0.9rem; opacity:0.8; margin-top:0.5rem;">Across all active sections</div>
                    </div>
                    <div class="card"
                        style="background:#10b981; color:white; padding:2rem; border-radius:1rem; box-shadow:0 10px 25px -5px rgba(16, 185, 129, 0.3);">
                        <div
                            style="font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; opacity:0.9; margin-bottom:0.5rem;">
                            Active Sections</div>
                        <div id="dash-active-sections" style="font-size:3rem; font-weight:700;">-</div>
                        <div style="font-size:0.9rem; opacity:0.8; margin-top:0.5rem;">Configured Sheets</div>
                    </div>
                </div>

                <!-- Performance Graph -->
                <div class="card" style="margin-bottom: 2rem; padding: 1.5rem; width: 100%; max-width: 100%;">
                    <h3 style="margin-bottom: 1rem; color: var(--text); font-weight: 600;">Overall Section Performance
                    </h3>
                    <div style="height: 500px; width: 100%;">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>

                <!-- Sections Grid/Table -->
                <h3 style="margin-bottom:1.5rem; color:var(--text); font-weight:600; font-size: 1.25rem;">
                    Section Performance Overview
                </h3>
                <div class="card" style="padding:0; overflow-x:auto; max-width:100%; border-radius: 0.8rem;">
                    <table style="width:100%; border-collapse:collapse; min-width: 600px;">
                        <thead style="background:#f8fafc; border-bottom:2px solid #e2e8f0;">
                            <tr>
                                <th
                                    style="padding:1.2rem; text-align:left; font-size:0.85rem; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">
                                    Section Name</th>
                                <th
                                    style="padding:1.2rem; text-align:center; font-size:0.85rem; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">
                                    Students</th>
                                <th
                                    style="padding:1.2rem; text-align:center; font-size:0.85rem; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">
                                    Avg Marks</th>
                                <th
                                    style="padding:1.2rem; text-align:center; font-size:0.85rem; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">
                                    Highest</th>
                                <th
                                    style="padding:1.2rem; text-align:center; font-size:0.85rem; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">
                                    Lowest</th>
                            </tr>
                        </thead>
                        <tbody id="dash-sections-body">
                            <tr>
                                <td colspan="5" style="padding:2rem; text-align:center; color:#94a3b8;">Loading data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB 1: SOURCES -->
            <div id="tab-sources" style="display:none;">
                <h2>Google Sheets Sources</h2>

                <div class="card" style="max-width: 600px; margin: 1rem 0;">
                    <form onsubmit="addSource(event)">
                        <div class="input-group">
                            <label>Sheet Name</label>
                            <input type="text" id="sheet-name" placeholder="e.g. Section A, Morning Batch" required>
                        </div>
                        <div class="input-group">
                            <label>Spreadsheet ID or URL</label>
                            <input type="text" id="sheet-id" placeholder="Paste full URL or just the ID" required>
                        </div>
                        <div class="input-group">
                            <label>Range (Optional)</label>
                            <input type="text" id="sheet-range" value="Sheet1!A2:Z">
                        </div>
                        <button class="btn-primary">Add Source</button>
                    </form>
                </div>

                <div class="source-list" id="source-list">
                    <!-- Sources will be listed here -->
                </div>
            </div> <!-- End Tab Sources -->

            <!-- TAB 2: RESULTS -->
            <div id="tab-results" style="display:none">
                <h2>Check Student Result</h2>
                <div class="card" style="max-width: 600px; margin: 1rem 0;">
                    <form onsubmit="searchStudent(event)">
                        <div class="input-group">
                            <label>Student Roll Number</label>
                            <input type="text" id="search-roll" placeholder="e.g. Fa-2024/BS CMAI/111" required>
                        </div>
                        <button class="btn-primary">Search</button>
                    </form>
                </div>
                <div id="result-display" style="margin-top: 2rem;"></div>
            </div>

            <!-- TAB 3: CLASS STATISTICS & GRADES -->
            <div id="tab-statistics" style="display:none">
                <h2>Class Statistics & Relative Grades</h2>


                <div class="card" style="max-width: 600px; margin: 1rem auto;">
                    <form onsubmit="loadClassStatistics(event)">
                        <div class="input-group">
                            <label>Select Marksheet</label>
                            <select id="stats-sheet-select" required
                                style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-family: 'Outfit', sans-serif; font-size: 1rem;">
                                <option value="">-- Choose a sheet --</option>
                            </select>
                        </div>
                        <button class="btn-primary">View Statistics</button>
                    </form>
                </div>

                <!-- Grading Configuration Panel (Added Request) -->
                <div id="grading-config-section"
                    style="display:none; background:white; padding:1.5rem; border-radius:1rem; margin:1.5rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
                        <h3 style="margin:0; font-size:1.1rem; color:var(--primary)">Grading Rules</h3>
                        <select id="grading-method" onchange="toggleGradingUI()"
                            style="padding:0.5rem; border:1px solid #e2e8f0; border-radius:0.5rem; font-family:'Outfit'">
                            <option value="automatic">Automatic (University Standard)</option>
                            <option value="percentage-based">Percentage Based</option>
                            <option value="class-limits">Class Limits (Top N)</option>
                            <option value="manual">Manual Assignment</option>
                        </select>
                    </div>

                    <div id="ui-percentage" style="display:none">
                        <p style="font-size:0.9rem; color:#64748b; margin-bottom:1rem">Assign grades based on percentage
                            of marks (out of 55). Enter minimum % for each.</p>
                        <div
                            style="display:grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap:10px">
                            <div><label style="font-size:0.8rem">A+</label><input type="number" id="p-a-plus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="90"></div>
                            <div><label style="font-size:0.8rem">A</label><input type="number" id="p-a"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="85"></div>
                            <div><label style="font-size:0.8rem">A-</label><input type="number" id="p-a-minus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="80"></div>
                            <div><label style="font-size:0.8rem">B+</label><input type="number" id="p-b-plus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="75"></div>
                            <div><label style="font-size:0.8rem">B</label><input type="number" id="p-b"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="70"></div>
                            <div><label style="font-size:0.8rem">B-</label><input type="number" id="p-b-minus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="65"></div>
                            <div><label style="font-size:0.8rem">C+</label><input type="number" id="p-c-plus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="60"></div>
                            <div><label style="font-size:0.8rem">C</label><input type="number" id="p-c"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="55"></div>
                            <div><label style="font-size:0.8rem">C-</label><input type="number" id="p-c-minus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="50"></div>
                            <div><label style="font-size:0.8rem">D+</label><input type="number" id="p-d-plus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="45"></div>
                            <div><label style="font-size:0.8rem">D</label><input type="number" id="p-d"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="40"></div>
                            <div><label style="font-size:0.8rem">D-</label><input type="number" id="p-d-minus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="35"></div>
                            <div><label style="font-size:0.8rem">F</label><input type="number" id="p-f"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="0"></div>
                        </div>
                    </div>

                    <div id="ui-limits" style="display:none">
                        <p style="font-size:0.9rem; color:#64748b; margin-bottom:1rem">Assign grades by Rank. Enter max
                            students for each grade.</p>
                        <div
                            style="display:grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap:10px">
                            <div><label style="font-size:0.8rem">A+</label><input type="number" id="l-a-plus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="2"></div>
                            <div><label style="font-size:0.8rem">A</label><input type="number" id="l-a"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">A-</label><input type="number" id="l-a-minus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">B+</label><input type="number" id="l-b-plus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">B</label><input type="number" id="l-b"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">B-</label><input type="number" id="l-b-minus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">C+</label><input type="number" id="l-c-plus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">C</label><input type="number" id="l-c"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">C-</label><input type="number" id="l-c-minus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">D+</label><input type="number" id="l-d-plus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">D</label><input type="number" id="l-d"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">D-</label><input type="number" id="l-d-minus"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="5"></div>
                            <div><label style="font-size:0.8rem">F</label><input type="number" id="l-f"
                                    style="width:100%; border:1px solid #cbd5e1; padding:4px; border-radius:4px"
                                    placeholder="0"></div>
                        </div>
                    </div>

                    <div style="margin-top:1.5rem; text-align:right">
                        <button class="btn-primary" onclick="applyGradingRules()">Apply Rules</button>
                    </div>
                </div>

                <!-- Grade Distribution Bell Curve -->
                <div id="grade-distribution-chart" style="display:none; margin: 2rem 0;">
                    <div class="card" style="max-width: 100%; padding: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">Grades Distribution Graph</h3>
                        <div style="overflow-x: auto; padding-bottom: 1rem;">
                            <div id="bell-curve-container"
                                style="display: flex; align-items: flex-end; justify-content: space-around; gap: 0.5rem; height: 200px; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; min-width: 600px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Summary Cards -->
                <div id="stats-summary" style="display:none; margin: 2rem 0;">
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="card" style="text-align: center; background: #6366f1; color: white;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Total Students</div>
                            <div id="stat-total" style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem;">0</div>
                        </div>
                        <div class="card" style="text-align: center; background: #3b82f6; color: white;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Class Average</div>
                            <div id="stat-average" style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem;">0
                            </div>
                        </div>
                        <div class="card" style="text-align: center; background: #10b981; color: white;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Highest Score</div>
                            <div id="stat-highest" style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem;">0
                            </div>
                        </div>
                        <div class="card" style="text-align: center; background: #f43f5e; color: white;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Lowest Score</div>
                            <div id="stat-lowest" style="font-size: 2rem; font-weight: 700; margin-top: 0.5rem;">0</div>
                        </div>
                    </div>

                    <!-- Student Results Table -->
                    <div id="stats-table-container" style="display:none;">
                        <div class="card" style="max-width: 100%; padding: 1.5rem;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="color: var(--primary);">Student Results with Relative Grades</h3>
                                <button onclick="exportToCSV()" class="btn-secondary"
                                    style="padding: 0.5rem 1rem; font-size: 0.9rem;">Export CSV</button>
                            </div>
                            <div style="overflow-x: auto;">
                                <table id="stats-table"
                                    style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                    <thead style="background: #f8fafc; position: sticky; top: 0;">
                                        <tr id="stats-table-header">
                                            <th
                                                style="padding: 0.5rem 0.3rem; text-align: left; border-bottom: 2px solid #e2e8f0; font-size: 0.7rem;">
                                                Rank</th>
                                            <th
                                                style="padding: 0.5rem 0.3rem; text-align: left; border-bottom: 2px solid #e2e8f0; font-size: 0.7rem; min-width: 80px;">
                                                Roll No</th>
                                            <th
                                                style="padding: 0.5rem 0.3rem; text-align: left; border-bottom: 2px solid #e2e8f0; font-size: 0.7rem; min-width: 100px;">
                                                Name</th>
                                        </tr>
                                    </thead>
                                    <tbody id="stats-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
        </main>
    </div>

    <!-- Edit Source Modal -->
    <div id="edit-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
        <div class="card" style="width: 100%; max-width: 500px; margin: 2rem;">
            <h2 style="margin-bottom: 0.5rem">Edit Source</h2>
            <form onsubmit="handleEditSource(event)">
                <div class="input-group">
                    <label>Sheet Name</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="input-group">
                    <label>Spreadsheet ID</label>
                    <input type="text" id="edit-sheet-id" required>
                </div>
                <div class="input-group">
                    <label>Range</label>
                    <input type="text" id="edit-range" required>
                </div>
                <div style="display:flex; gap:1rem; margin-top:1rem;">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    <!-- ADMIN SPLIT AUTH LAYOUT -->
    <div id="admin-auth-container" class="split-layout">
        <!-- Left Side: Forms -->
        <div class="split-left dark-form">

            <!-- Login Wrapper -->
            <div id="admin-login-wrapper">
                <h2>Admin Login</h2>
                <form onsubmit="handleAdminLogin(event)">
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="adm-email" placeholder="admin@example.com" required>
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="adm-pass" placeholder="••••••••" required>
                    </div>
                    <button class="btn-primary">Login</button>

                    <div class="auth-toggle">
                        First time here? <a onclick="toggleAdminForms('register')">Create Account</a>
                    </div>

                    <div
                        style="margin-top: 1.5rem; text-align: center; border-top: 1px solid #374151; padding-top: 1rem;">
                        <a href="/" style="color: #64748b; text-decoration: none; font-size: 0.85rem;">← Student
                            Portal</a>
                    </div>
                </form>
            </div>

            <!-- Register Wrapper (Hidden) -->
            <div id="admin-register-wrapper" style="display:none">
                <h2>Admin Registration</h2>
                <p class="subtitle">Create a new admin account</p>
                <form onsubmit="handleAdminRegister(event)">
                    <div class="input-group">
                        <label>Name</label>
                        <input type="text" id="reg-adm-name" placeholder="Full Name" required>
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="reg-adm-email" placeholder="admin@example.com" required>
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="reg-adm-pass" placeholder="Create Password" required>
                    </div>
                    <button class="btn-primary">Register</button>

                    <div class="auth-toggle">
                        Already have an account? <a onclick="toggleAdminForms('login')">Login</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Side: Illustration -->
        <div class="split-right">
            <h1>Admin Control Center</h1>
            <p style="margin-top: 1rem; opacity: 0.9; font-size: 1.1rem;">Securely manage academic records</p>

            <div class="illustration-container">
                <img src="admin.png" alt="Admin Control Center" class="illustration-svg"
                    style="max-width: 100%; height: auto;">
            </div>
        </div>
    </div>

    <footer class="site-footer transparent-footer">
        <div></div>
        <div class="footer-links">
            <span>&copy; 2026 ARK-ONE All rights Reserved</span>
            <a href="privacy.html" target="_blank">Privacy Policy</a>
            <a href="terms.html" target="_blank">Terms of Use</a>
        </div>
    </footer>

    <script>
        const API_URL = '/api/admin';

        async function handleAdminLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adm-email').value;
            const password = document.getElementById('adm-pass').value;

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('adminToken', data.token);
                    checkAuth();
                } else {
                    alert('Invalid credentials');
                }
            } catch (e) { console.error(e); }
        }

        function toggleAdminForms(type) {
            const loginWrap = document.getElementById('admin-login-wrapper');
            const regWrap = document.getElementById('admin-register-wrapper');

            if (type === 'register') {
                loginWrap.style.display = 'none';
                regWrap.style.display = 'block';
            } else {
                regWrap.style.display = 'none';
                loginWrap.style.display = 'block';
            }
        }

        async function handleAdminRegister(e) {
            e.preventDefault();
            const name = document.getElementById('reg-adm-name').value;
            const email = document.getElementById('reg-adm-email').value;
            const password = document.getElementById('reg-adm-pass').value;

            try {
                const res = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Registered! Please login.');
                    toggleAdminForms('login');
                } else {
                    alert(data.detail);
                }
            } catch (e) { console.error(e); }
        }

        async function addSource(e) {
            e.preventDefault();
            const name = document.getElementById('sheet-name').value.trim();
            let sheetId = document.getElementById('sheet-id').value.trim();
            const range = document.getElementById('sheet-range').value;
            const token = localStorage.getItem('adminToken');

            // Auto-extract ID if full URL pasted
            const urlMatch = sheetId.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (urlMatch) {
                sheetId = urlMatch[1];
            }

            try {
                const res = await fetch(`${API_URL}/add-source`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ sheetId, range, name })
                });
                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    document.getElementById('sheet-name').value = '';
                    document.getElementById('sheet-id').value = '';
                    loadSources();
                } else {
                    alert('Failed to add source: ' + (data.detail || data.message || 'Unknown error'));
                }
            } catch (e) { alert('Error adding source'); }
        }

        async function refreshData() {
            const btn = document.querySelector('button[onclick="refreshData()"]');
            const originalText = btn.textContent;
            btn.textContent = "Refreshing...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/refresh`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('Success! Latest data fetched from Google Sheets.');
                    loadSources();
                } else {
                    alert('Refresh failed.');
                }
            } catch (e) {
                alert('Connection error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function checkAuth() {
            const footer = document.querySelector('.site-footer');
            if (localStorage.getItem('adminToken')) {
                document.getElementById('admin-auth-container').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'grid';
                if (document.querySelector('.navbar')) document.querySelector('.navbar').style.display = 'flex';
                document.getElementById('logout-btn').style.display = 'inline-block';
                if (footer) footer.classList.remove('transparent-footer');
                loadSources();
                loadDashboard();
            } else {
                document.getElementById('admin-auth-container').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
                if (document.querySelector('.navbar')) document.querySelector('.navbar').style.display = 'none';
                if (footer) footer.classList.add('transparent-footer');
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        function toggleSidebar() {
            const panel = document.getElementById('admin-panel');
            panel.classList.toggle('sidebar-visible');
        }

        async function loadSources() {
            try {
                const res = await fetch(`${API_URL}/sources`);
                const data = await res.json();
                if (data.success && data.sources) {
                    const list = document.getElementById('source-list');
                    list.innerHTML = data.sources.map(s => `
                        <div class="source-item" style="align-items: center;">
                            <div style="flex: 1">
                                <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.3rem; color: var(--primary);">
                                    ${s.name || 'Unnamed Sheet'}
                                </div>
                                <div style="font-size:0.85rem; color:#64748b;">
                                    ${s.sheetId.substring(0, 20)}...
                                </div>
                                <small style="color: #94a3b8">${s.range}</small>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button onclick="openEditModal('${s.sheetId}', '${s.name}', '${s.range}')" 
                                    class="btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                    Edit
                                </button>
                                <a href="https://docs.google.com/spreadsheets/d/${s.sheetId}" target="_blank" 
                                   class="btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; text-decoration: none; display: inline-block;">
                                   Open ↗
                                </a>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('source-list').innerHTML = '<div style="padding:1rem">No configurations found</div>';
                }
            } catch (e) { console.error("Failed to load sources"); }
        }

        let currentEditId = null;

        function openEditModal(id, name, range) {
            currentEditId = id;
            document.getElementById('edit-modal').style.display = 'flex';
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-range').value = range;
            document.getElementById('edit-sheet-id').value = id;
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditId = null;
        }

        async function handleEditSource(e) {
            e.preventDefault();
            const name = document.getElementById('edit-name').value;
            const sheetId = document.getElementById('edit-sheet-id').value;
            const range = document.getElementById('edit-range').value;

            try {
                const res = await fetch(`${API_URL}/update-source`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        oldSheetId: currentEditId,
                        sheetId,
                        name,
                        range
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Updated successfully');
                    closeEditModal();
                    loadSources();
                } else {
                    alert('Update failed: ' + data.detail);
                }
            } catch (err) {
                alert('Connection error');
            }
        }

        async function searchStudent(e) {
            e.preventDefault();
            const roll = document.getElementById('search-roll').value;
            const display = document.getElementById('result-display');
            display.innerHTML = '<p>Searching...</p>';

            try {
                const res = await fetch(`/api/marks/${encodeURIComponent(roll)}`);
                const data = await res.json();

                if (data.success) {
                    let marksHtml = '';
                    for (const [key, value] of Object.entries(data.marks)) {
                        if (key !== 'rollNumber' && key !== 'name') {
                            const valDisplay = (key === 'Total') ? `${value} / 100` : value;
                            marksHtml += `
                                <div style="display:flex; justify-content:space-between; padding:0.8rem 0; border-bottom:1px solid #eee">
                                    <span style="color:#64748b">${key}</span>
                                    <span style="font-weight:600">${valDisplay}</span>
                                </div>
                            `;
                        }
                    }

                    display.innerHTML = `
                        <div class="card" style="animation: slideUp 0.3s ease">
                            <h3 style="margin-bottom:1rem; color:var(--primary)">${data.marks.name || 'Student'}</h3>
                            <div style="margin-bottom:1.5rem; color:#64748b; font-size:0.9rem">
                                Roll No: ${data.marks.rollNumber}
                            </div>
                            ${marksHtml}
                        </div>
                    `;
                } else {
                    display.innerHTML = `<div style="padding:1rem; color:red; background:#fff; border-radius:8px">${data.detail || 'Student not found'}</div>`;
                }
            } catch (e) {
                display.innerHTML = `<p style="color:red">Error fetching result</p>`;
            }
        }

        function switchTab(tabName, linkElement) {
            document.getElementById('tab-dashboard').style.display = tabName === 'dashboard' ? 'block' : 'none';
            document.getElementById('tab-sources').style.display = tabName === 'sources' ? 'block' : 'none';
            document.getElementById('tab-results').style.display = tabName === 'results' ? 'block' : 'none';
            document.getElementById('tab-statistics').style.display = tabName === 'statistics' ? 'block' : 'none';

            // Update Sidebar Active State
            if (linkElement) {
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                linkElement.classList.add('active');
            }

            // Load data based on tab
            if (tabName === 'statistics') {
                populateSheetSelector();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            }
        }

        async function loadDashboard() {
            const token = localStorage.getItem('adminToken');
            if (!token) return;

            try {
                const res = await fetch(`${API_URL}/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success) {
                    // Update Profile
                    document.getElementById('dashboard-welcome').textContent = `Welcome, ${data.admin.name}`;
                    document.getElementById('dashboard-email').textContent = data.admin.email;

                    // Update Summary Cards
                    document.getElementById('dash-total-students').textContent = data.summary.totalStudents;

                    document.getElementById('dash-active-sections').textContent = data.summary.activeSections;

                    // Render Performance Chart
                    renderPerformanceChart(data.sections);

                    // Update Sections Table
                    const tbody = document.getElementById('dash-sections-body');
                    if (data.sections.length > 0) {
                        tbody.innerHTML = data.sections.map(sec => {
                            if (sec.error) {
                                return `
                                    <tr style="border-bottom:1px solid #f1f5f9; background: #fef2f2;">
                                        <td style="padding:1.2rem; font-weight:500;">
                                            ${sec.name}
                                            <div style="font-size:0.75rem; color:#ef4444; margin-top:0.25rem;">${sec.error}</div>
                                        </td>
                                        <td style="padding:1.2rem; text-align:center; color:#ef4444;">-</td>
                                        <td style="padding:1.2rem; text-align:center; color:#ef4444;">Error</td>
                                        <td style="padding:1.2rem; text-align:center;">-</td>
                                        <td style="padding:1.2rem; text-align:center;">-</td>
                                    </tr>
                                `;
                            }
                            return `
                                <tr style="border-bottom:1px solid #f1f5f9; hover:background:#f8fafc;">
                                    <td style="padding:1.2rem; font-weight:500;">${sec.name}</td>
                                    <td style="padding:1.2rem; text-align:center;">${sec.totalStudents}</td>
                                    <td style="padding:1.2rem; text-align:center; font-weight:600; color:#3b82f6;">${sec.classAverage}</td>
                                    <td style="padding:1.2rem; text-align:center; color:#10b981;">${sec.highest}</td>
                                    <td style="padding:1.2rem; text-align:center; color:#f43f5e;">${sec.lowest}</td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" style="padding:2rem; text-align:center; color:#64748b;">No sections active</td></tr>';
                    }
                }
            } catch (e) {
                console.error("Dashboard Load Error", e);
                document.getElementById('dashboard-email').textContent = 'System Error';
                document.getElementById('dash-total-students').innerHTML = '<span style="color:#f87171; font-size:1.5rem">Error</span>';
                document.getElementById('dash-sections-body').innerHTML = `<tr><td colspan="5" style="padding:2rem; text-align:center; color:#ef4444;">Failed to load data. Please refresh or check logs.</td></tr>`;
            }
        }

        let performanceChartInstance = null;

        function renderPerformanceChart(sections) {
            const ctx = document.getElementById('performance-chart').getContext('2d');

            // Destroy previous chart if exists
            if (performanceChartInstance) {
                performanceChartInstance.destroy();
            }

            // Performace Chart Data Preparation
            // Filter out errored sections
            const validSections = sections.filter(s => !s.error && s.performanceCurve && s.performanceCurve.length > 0);

            // Find max number of students to set X-axis
            const maxStudents = Math.max(60, ...validSections.map(s => s.performanceCurve.length));
            const labels = Array.from({ length: maxStudents }, (_, i) => i + 1);

            // Vibrant colors matching the theme
            const colors = [
                { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }, // Indigo
                { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' }, // Emerald
                { border: '#f43f5e', bg: 'rgba(244, 63, 94, 0.1)' },  // Rose
                { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' }, // Amber
                { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' }, // Violet
            ];

            const datasets = validSections.map((sec, index) => {
                // Plot ALL students in sequence (no slice)
                const dataPoints = sec.performanceCurve;

                const color = colors[index % colors.length];

                return {
                    label: sec.name,
                    data: dataPoints,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 2,
                    tension: 0.3, // Slightly less curve for raw data
                    pointRadius: 2, // Show points for individual students
                    pointHoverRadius: 5,
                    fill: false
                };
            });

            performanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true, boxWidth: 8 }
                        },
                        tooltip: {
                            callbacks: {
                                title: (context) => `Student #${context[0].label}`,
                                label: (context) => `${context.dataset.label}: ${context.raw} Marks`
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            title: { display: true, text: 'Marks (0-100)' },
                            grid: { color: '#f1f5f9' },
                            ticks: { stepSize: 10 }
                        },
                        x: {
                            title: { display: true, text: 'Student Sequence (Sheet Order)' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        let currentStatsData = null; // Store current statistics data for export

        async function populateSheetSelector() {
            try {
                const res = await fetch(`${API_URL}/sources`);
                const data = await res.json();

                const select = document.getElementById('stats-sheet-select');
                select.innerHTML = '<option value="">-- Choose a sheet --</option>';

                if (data.success && data.sources) {
                    data.sources.forEach(source => {
                        const option = document.createElement('option');
                        option.value = source.sheetId;
                        option.textContent = source.name || source.sheetId.substring(0, 20) + '...';
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Failed to load sheets:', e);
            }
        }

        async function loadClassStatistics(e) {
            e.preventDefault();

            const sheetId = document.getElementById('stats-sheet-select').value;
            if (!sheetId) {
                alert('Please select a marksheet');
                return;
            }

            // Show loading state
            document.getElementById('stats-summary').style.display = 'none';
            document.getElementById('stats-table-container').style.display = 'none';

            try {
                const res = await fetch(`${API_URL}/sheet-statistics/${encodeURIComponent(sheetId)}`);

                // Check if response is OK
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('API Error Response:', errorText);
                    alert(`Failed to load statistics (${res.status}): ${errorText}`);
                    return;
                }

                const data = await res.json();
                console.log('Statistics data:', data);

                if (data.success) {
                    currentStatsData = data; // Store for export
                    displayStatistics(data);
                } else {
                    const errorMsg = data.detail || data.message || 'Unknown error';
                    console.error('API returned error:', data);
                    alert('Failed to load statistics: ' + errorMsg);
                }
            } catch (e) {
                console.error('Error loading statistics:', e);
                alert('Error loading statistics: ' + e.message + '. Please check console for details.');
            }
        }

        function displayStatistics(data) {
            const { students, statistics, sheetName } = data;

            // Update summary cards
            document.getElementById('stat-total').textContent = statistics.totalStudents;
            document.getElementById('stat-average').textContent = statistics.classAverage.toFixed(2);
            document.getElementById('stat-highest').textContent = statistics.highestScore.toFixed(2);
            document.getElementById('stat-lowest').textContent = statistics.lowestScore.toFixed(2);

            // Update current marks total in note
            if (statistics.currentMarksTotal) {
                const totalEl = document.getElementById('current-total-marks');
                if (totalEl) totalEl.textContent = statistics.currentMarksTotal;
            }

            // Display grade distribution bell curve
            displayGradeDistribution(statistics.gradeDistribution, statistics.totalStudents);

            // Build table header dynamically - COMPACT VERSION
            const tableHeader = document.getElementById('stats-table-header');
            tableHeader.innerHTML = `
                <th style="padding: 1rem 0.5rem; text-align: left; border-bottom: 2px solid #e2e8f0; font-size: 0.9rem;">Rank</th>
                <th style="padding: 1rem 0.5rem; text-align: left; border-bottom: 2px solid #e2e8f0; font-size: 0.9rem; min-width: 100px;">Roll No</th>
                <th style="padding: 1rem 0.5rem; text-align: left; border-bottom: 2px solid #e2e8f0; font-size: 0.9rem; min-width: 150px;">Name</th>
            `;

            // Add subject columns - COMPACT
            statistics.headers.forEach(header => {
                if (header.toLowerCase() !== 'total') {
                    tableHeader.innerHTML += `<th style="padding: 1rem 0.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; font-size: 0.9rem;">${header}</th>`;
                }
            });

            // Add total, percentage, and grade columns - COMPACT
            tableHeader.innerHTML += `
                <th style="padding: 1rem 0.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; font-weight: 700; font-size: 0.9rem;">Total</th>
                <th style="padding: 1rem 0.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; font-weight: 700; font-size: 0.9rem;">%</th>
                <th style="padding: 1rem 0.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; font-weight: 700; font-size: 0.9rem;">Grade</th>
            `;

            // Build table body
            const tableBody = document.getElementById('stats-table-body');
            tableBody.innerHTML = '';

            students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.style.cssText = 'border-bottom: 1px solid #e2e8f0; transition: background 0.2s;';
                row.onmouseenter = () => row.style.background = '#f8fafc';
                row.onmouseleave = () => row.style.background = 'white';

                // Rank display
                let rankDisplay = index + 1;

                let rowHTML = `
                    <td style="padding: 1rem 0.5rem; font-weight: 600; font-size: 0.9rem;">${rankDisplay}</td>
                    <td style="padding: 1rem 0.5rem; color: #64748b; font-size: 0.9rem;">${student.rollNumber}</td>
                    <td style="padding: 1rem 0.5rem; font-weight: 500; font-size: 0.9rem;">${student.name}</td>
                `;

                // Add subject marks - COMPACT
                statistics.headers.forEach(header => {
                    if (header.toLowerCase() !== 'total') {
                        const mark = student.marks[header] !== undefined ? student.marks[header] : '-';
                        rowHTML += `<td style="padding: 1rem 0.5rem; text-align: center; font-size: 0.9rem;">${mark}</td>`;
                    }
                });

                // Grade color coding - 13 levels
                const gradeColors = {
                    // A grades - Green shades (Excellent)
                    'A+': '#059669',  // Emerald 600 - Darkest green for top grade
                    'A': '#10b981',   // Emerald 500 - Bright green
                    'A-': '#34d399',  // Emerald 400 - Light green

                    // B grades - Blue shades (Good)
                    'B+': '#2563eb',  // Blue 600 - Dark blue
                    'B': '#3b82f6',   // Blue 500 - Bright blue
                    'B-': '#60a5fa',  // Blue 400 - Light blue

                    // C grades - Orange/Yellow shades (Average)
                    'C+': '#d97706',  // Amber 600 - Dark orange
                    'C': '#f59e0b',   // Amber 500 - Orange
                    'C-': '#fbbf24',  // Amber 400 - Light orange/yellow

                    // D grades - Red/Pink shades (Below Average)
                    'D+': '#dc2626',  // Red 600 - Dark red
                    'D': '#ef4444',   // Red 500 - Red
                    'D-': '#f87171',  // Red 400 - Light red

                    // F grade - Deep red (Fail)
                    'F': '#991b1b'    // Red 800 - Very dark red
                };
                const gradeColor = gradeColors[student.grade] || '#64748b';

                rowHTML += `
                    <td style="padding: 1rem 0.5rem; text-align: center; font-weight: 700; color: var(--primary); font-size: 0.9rem;">${student.total.toFixed(2)}</td>
                    <td style="padding: 1rem 0.5rem; text-align: center; font-weight: 600; font-size: 0.9rem;">${student.percentage}%</td>
                    <td style="padding: 1rem 0.5rem; text-align: center;">
                        <span style="background: ${gradeColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.3rem; font-weight: 700; font-size: 0.9rem;">
                            ${student.grade}
                        </span>
                    </td>
                `;

                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });

            // Show the results
            document.getElementById('stats-summary').style.display = 'block';
            document.getElementById('stats-table-container').style.display = 'block';
            document.getElementById('grading-config-section').style.display = 'block';
            document.getElementById('grade-distribution-chart').style.display = 'block';

            // Smooth scroll to results
            document.getElementById('stats-summary').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function displayGradeDistribution(gradeDistribution, totalStudents) {
            const container = document.getElementById('bell-curve-container');
            container.innerHTML = '';

            // Grade order for display
            const gradeOrder = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-', 'F'];

            // Grade colors matching the table
            const gradeColors = {
                'A+': '#059669', 'A': '#10b981', 'A-': '#34d399',
                'B+': '#2563eb', 'B': '#3b82f6', 'B-': '#60a5fa',
                'C+': '#d97706', 'C': '#f59e0b', 'C-': '#fbbf24',
                'D+': '#dc2626', 'D': '#ef4444', 'D-': '#f87171',
                'F': '#991b1b'
            };

            // Get counts for each grade
            const counts = gradeOrder.map(grade => gradeDistribution[grade] || 0);
            const maxCount = Math.max(...counts, 1);

            // Create SVG for smooth curve
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "200");
            svg.setAttribute("viewBox", "0 0 800 200");
            svg.style.cssText = "background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); border-radius: 0.5rem;";

            // Calculate points for the curve
            const width = 800;
            const height = 200;
            const padding = 40;
            const pointSpacing = (width - 2 * padding) / (gradeOrder.length - 1);

            // Create points array
            const points = counts.map((count, index) => {
                const x = padding + index * pointSpacing;
                const y = height - padding - ((count / maxCount) * (height - 2 * padding));
                return { x, y, count, grade: gradeOrder[index] };
            });

            // Create smooth curve path using quadratic bezier curves
            let pathD = `M ${points[0].x} ${points[0].y}`;

            for (let i = 0; i < points.length - 1; i++) {
                const current = points[i];
                const next = points[i + 1];
                const controlX = (current.x + next.x) / 2;
                const controlY = (current.y + next.y) / 2;
                pathD += ` Q ${controlX} ${current.y}, ${controlX} ${controlY}`;
                pathD += ` Q ${controlX} ${next.y}, ${next.x} ${next.y}`;
            }

            // Create gradient for fill
            const defs = document.createElementNS(svgNS, "defs");
            const gradient = document.createElementNS(svgNS, "linearGradient");
            gradient.setAttribute("id", "curveGradient");
            gradient.setAttribute("x1", "0%");
            gradient.setAttribute("y1", "0%");
            gradient.setAttribute("x2", "0%");
            gradient.setAttribute("y2", "100%");

            const stop1 = document.createElementNS(svgNS, "stop");
            stop1.setAttribute("offset", "0%");
            stop1.setAttribute("stop-color", "#8b5cf6");
            stop1.setAttribute("stop-opacity", "0.8");

            const stop2 = document.createElementNS(svgNS, "stop");
            stop2.setAttribute("offset", "100%");
            stop2.setAttribute("stop-color", "#8b5cf6");
            stop2.setAttribute("stop-opacity", "0.1");

            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            defs.appendChild(gradient);
            svg.appendChild(defs);

            // Create filled area under curve
            const fillPath = document.createElementNS(svgNS, "path");
            const fillD = pathD + ` L ${points[points.length - 1].x} ${height - padding} L ${points[0].x} ${height - padding} Z`;
            fillPath.setAttribute("d", fillD);
            fillPath.setAttribute("fill", "url(#curveGradient)");
            fillPath.setAttribute("opacity", "0.6");
            svg.appendChild(fillPath);

            // Create the main curve line
            const path = document.createElementNS(svgNS, "path");
            path.setAttribute("d", pathD);
            path.setAttribute("fill", "none");
            path.setAttribute("stroke", "#a78bfa");
            path.setAttribute("stroke-width", "3");
            path.setAttribute("stroke-linecap", "round");
            svg.appendChild(path);

            // Add dots and labels for each grade
            points.forEach((point, index) => {
                // Dot
                const circle = document.createElementNS(svgNS, "circle");
                circle.setAttribute("cx", point.x);
                circle.setAttribute("cy", point.y);
                circle.setAttribute("r", "5");
                circle.setAttribute("fill", gradeColors[point.grade]);
                circle.setAttribute("stroke", "#fff");
                circle.setAttribute("stroke-width", "2");
                circle.style.cursor = "pointer";

                // Hover effect
                circle.addEventListener("mouseenter", function () {
                    this.setAttribute("r", "8");
                });
                circle.addEventListener("mouseleave", function () {
                    this.setAttribute("r", "5");
                });

                svg.appendChild(circle);

                // Count label above dot
                if (point.count > 0) {
                    const countText = document.createElementNS(svgNS, "text");
                    countText.setAttribute("x", point.x);
                    countText.setAttribute("y", point.y - 15);
                    countText.setAttribute("text-anchor", "middle");
                    countText.setAttribute("fill", "#e2e8f0");
                    countText.setAttribute("font-size", "12");
                    countText.setAttribute("font-weight", "600");
                    countText.textContent = point.count;
                    svg.appendChild(countText);
                }

                // Grade label at bottom
                const gradeText = document.createElementNS(svgNS, "text");
                gradeText.setAttribute("x", point.x);
                gradeText.setAttribute("y", height - 10);
                gradeText.setAttribute("text-anchor", "middle");
                gradeText.setAttribute("fill", gradeColors[point.grade]);
                gradeText.setAttribute("font-size", "11");
                gradeText.setAttribute("font-weight", "700");
                gradeText.textContent = point.grade;
                svg.appendChild(gradeText);
            });

            container.appendChild(svg);
        }

        function exportToCSV() {
            if (!currentStatsData) {
                alert('No data to export');
                return;
            }

            const { students, statistics, sheetName } = currentStatsData;

            // Build CSV content
            let csv = 'Rank,Roll Number,Name,';

            // Add subject headers
            statistics.headers.forEach(header => {
                if (header.toLowerCase() !== 'total') {
                    csv += `${header},`;
                }
            });
            csv += 'Total,Percentage,Grade\n';

            // Add student data
            students.forEach((student, index) => {
                csv += `${index + 1},${student.rollNumber},${student.name},`;

                statistics.headers.forEach(header => {
                    if (header.toLowerCase() !== 'total') {
                        const mark = student.marks[header] !== undefined ? student.marks[header] : '-';
                        csv += `${mark},`;
                    }
                });

                csv += `${student.total.toFixed(2)},${student.percentage},${student.grade}\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${sheetName || 'class'}_statistics_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        checkAuth();

        function toggleGradingUI() {
            const method = document.getElementById('grading-method').value;
            document.getElementById('ui-percentage').style.display = (method === 'percentage-based') ? 'block' : 'none';
            document.getElementById('ui-limits').style.display = (method === 'class-limits') ? 'block' : 'none';
        }

        async function applyGradingRules() {
            const sheetId = document.getElementById('stats-sheet-select').value;
            if (!sheetId) return alert('Select a sheet first');

            const method = document.getElementById('grading-method').value;
            const btn = document.querySelector('#grading-config-section button');
            const originalText = btn.textContent;

            // Build config object
            const config = {
                sheetId: sheetId,
                method: method,
                ranges: {},
                limits: {}
            };

            if (method === 'percentage-based') {
                config.ranges = {
                    'A+': parseFloat(document.getElementById('p-a-plus').value) || 0,
                    'A': parseFloat(document.getElementById('p-a').value) || 0,
                    'A-': parseFloat(document.getElementById('p-a-minus').value) || 0,
                    'B+': parseFloat(document.getElementById('p-b-plus').value) || 0,
                    'B': parseFloat(document.getElementById('p-b').value) || 0,
                    'B-': parseFloat(document.getElementById('p-b-minus').value) || 0,
                    'C+': parseFloat(document.getElementById('p-c-plus').value) || 0,
                    'C': parseFloat(document.getElementById('p-c').value) || 0,
                    'C-': parseFloat(document.getElementById('p-c-minus').value) || 0,
                    'D+': parseFloat(document.getElementById('p-d-plus').value) || 0,
                    'D': parseFloat(document.getElementById('p-d').value) || 0,
                    'D-': parseFloat(document.getElementById('p-d-minus').value) || 0,
                    'F': parseFloat(document.getElementById('p-f').value) || 0
                };
            } else if (method === 'class-limits') {
                config.limits = {
                    'A+': parseInt(document.getElementById('l-a-plus').value) || 0,
                    'A': parseInt(document.getElementById('l-a').value) || 0,
                    'A-': parseInt(document.getElementById('l-a-minus').value) || 0,
                    'B+': parseInt(document.getElementById('l-b-plus').value) || 0,
                    'B': parseInt(document.getElementById('l-b').value) || 0,
                    'B-': parseInt(document.getElementById('l-b-minus').value) || 0,
                    'C+': parseInt(document.getElementById('l-c-plus').value) || 0,
                    'C': parseInt(document.getElementById('l-c').value) || 0,
                    'C-': parseInt(document.getElementById('l-c-minus').value) || 0,
                    'D+': parseInt(document.getElementById('l-d-plus').value) || 0,
                    'D': parseInt(document.getElementById('l-d').value) || 0,
                    'D-': parseInt(document.getElementById('l-d-minus').value) || 0,
                    'F': parseInt(document.getElementById('l-f').value) || 0
                };
            }

            try {
                btn.textContent = 'Calculating...';
                btn.disabled = true;

                const res = await fetch(`${API_URL}/calculate-grades`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(config)
                });

                const data = await res.json();
                if (data.success) {
                    displayStatistics(data.statistics);
                    // Feedback handled by UI update
                } else {
                    alert(data.detail || 'Error calculating grades');
                }
            } catch (e) {
                console.error(e);
                alert('Connection error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

    </script>
</body>

</html>